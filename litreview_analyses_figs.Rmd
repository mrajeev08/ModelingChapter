---
title: "FiguresTables"
author: "Malavika Rajeev"
date: "8/6/2019"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(rgdal)
library(ggthemes)
library(ggsn)
library(tidyverse)
library(patchwork)
library(UpSetR)
newtheme <- theme_classic() + theme(text = element_text(size = 25), panel.background = element_blank())

```

## Figure 1

### Coverage example

```{r coverage}
## Project population
vacc_reconstruct <- function(t, y, parms){
  dS <- -parms["deaths"] * y["S"] + parms["births"] * (y["S"] + y["V"]) + parms["waning"] * y["V"]
  dV <- -parms["deaths"] * y["V"] - parms["waning"] * y["V"]
  dWaning <- -parms["waning"] * y["V"]
  dDeaths <- -parms["deaths"] * y["V"]
  dBirths <- -parms["births"] * (y["S"] + y["V"])
  return(list(c(dS, dV)))
} 

eventfun <- function(t, y, parms){
  with (as.list(y),{
    diff <- 0.7*(S + V) - V ## newly vaccinated
    V <- V + diff
    S <- S - diff
    return(c(S, V))
  })
}


## times in relevant timestep
times <- seq (1/52, 5, by = 1/52) ## weekly for 10 years

## initial pop
IS <- 70000
IV <- 0

## param
births <- 0.50
deaths <- 0.42
waning <- 0.33
parms <- c(deaths = deaths, births = births, waning = waning)

## run
calcsus <- lsoda(y = c(S = IS, V = IV), times = times, func = vacc_reconstruct, parms = parms, 
                 events = list(func = eventfun, time = seq(1/52, 5, by = 1)))
vacc_df <- data.frame(Year = calcsus[, "time"], propVacc = calcsus[,"V"]/(calcsus[,"V"] + calcsus[,"S"]))
vacc_a <- ggplot(data = vacc_df, aes(x = Year, y = propVacc)) +
  geom_line(color = "lightseagreen", size = 1) +
  xlab ("Year") +
  ylab("Coverage") + 
  ylim(c(0, 1)) +
  geom_hline(yintercept = 0.69, color = "aquamarine4", linetype = 2, size = 1) +
  newtheme +
  theme(text = element_text(color = "aquamarine4"), axis.text = element_text(color = "aquamarine4"), 
        axis.line = element_line(color = "aquamarine4"))
ggsave("figs/fig1/vacc_a.jpg", vacc_a, device = "jpeg", width = 5, height = 5)
vacc_a
```

### Secondary cases
```{r R0}
## params
secondaries <- data.frame(secondaries = rnbinom(1000, mu = 1.2, size = 1.3))
sec_b <- ggplot(data = secondaries, aes(x = secondaries)) +
  geom_histogram(binwidth = 1, color = "lightgray", fill = "red", alpha = 0.5) +
  geom_vline(xintercept = 1.2, color = "red", linetype = 2, size = 1.1) +
  xlab("Secondary cases") +
  ylab("Frequency") +
  newtheme +
  theme(text = element_text(color = alpha("firebrick3", 1)),
        axis.text = element_text(color = alpha("firebrick3", 1)), 
        axis.line = element_line(color = alpha("firebrick3", 1)))
ggsave("figs/fig1/sec_b.jpg", sec_b, device = "jpeg", width = 5, height = 5)
sec_b
```

### Incubation period
```{r incubation}
incubation <- as.data.frame(list(Days = seq(0, 365, 1), 
                           Density = dgamma(seq(0, 365, 1), shape = 1.1518, 
                                    rate = 0.0429)))
inc_c <- ggplot(data = incubation, aes (x = Days, y = Density)) +
  geom_line(color = "darkred", size = 1.2) +
  xlab("Incubation Period \n (days)") +
  geom_vline(xintercept = 22.3, color = "darkred", linetype = 2, size = 1.1, alpha = 0.5) +
  newtheme +
  theme(text = element_text(color = "darkred"), axis.text = element_text(color = "darkred"), 
        axis.line = element_line(color = "darkred"))
ggsave("figs/fig1/inc_c.jpg", inc_c, device = "jpeg", width = 5, height = 5)
inc_c
```

### Infectious period
```{r infectious}
infectious <- as.data.frame(list(Days = seq(0, 10, 0.1), 
                           Density = dgamma(seq(0, 10, 0.1), shape = 2.9012, 
                                    rate = 1.013)))
inf_d <- ggplot(data = infectious, aes (x = Days, y = Density)) +
  geom_line(color = "navy", size = 1.2) +
  xlab("Infectious Period \n (days)") +
  geom_vline(xintercept = 3.1, color = "navy", linetype = 2, size = 1.2, alpha = 0.5) +
  newtheme +
  theme(text = element_text(color = "navy"), axis.text = element_text(color = "navy"), 
        axis.line = element_line(color = "navy"))
ggsave("figs/fig1/inf_d.jpg", inf_d, device = "jpeg", width = 5, height = 5)
inf_d
```

### Road network with scale
```{r roads}
tz_roads <- readOGR("data/gis/Tanzania_Roads/Tanzania_Roads.shp")
tz_roads <- fortify(tz_roads)
# TZ <- readOGR("data/tza_admbnda_adm0_20181019/tza_admbnda_adm0_20181019.shp")
# TZ <- fortify(TZ)
# ggplot(data = TZ, aes(x = long, y = lat, group = group)) +
#   geom_polygon(fill = "white", color = "grey") +
#   geom_line(data = tz_roads, aes(x = long, y = lat, group = group)) +
#   theme_map()


map_e1 <- ggplot(data = tz_roads, aes(x = long, y = lat, group = group)) +
  geom_line(color = "mediumorchid4") +
  scalebar(tz_roads, location = "bottomleft", 
           dist = 200, dist_unit = "km", transform = TRUE, box.fill = c("mediumorchid4", "grey"),
           box.color =  c("mediumorchid4", "grey"),
           st.size = 5, st.dist = 0.05, st.color = "mediumorchid4", 
           height = 0.02, model = 'WGS84') +
  theme_map()
ggsave("figs/fig1/map_e1.jpg", map_e1, device = "jpeg", width = 5, height = 5)
map_e1
```

### Dispersal kernel
```{r dispersal}
## params
dispersal <- as.data.frame(list(km = seq(0, 10, 0.01), 
                           Density = dgamma(seq(0, 10, 0.01), shape = 0.215, 
                                    scale = 0.245)))
disp_e2 <- ggplot(data = dispersal, aes (x = km, y = Density)) +
  geom_line(color = "mediumorchid4", size = 1.2) +
  xlab("Distance to next bite \n (km)") +
  geom_vline(xintercept = 0.88, color = "mediumorchid4", linetype = 2, size = 1.2, alpha = 0.75) +
  newtheme +
  theme(text = element_text(color = "mediumorchid4"), axis.text = element_text(color = "mediumorchid4"), 
        axis.line = element_line(color = "mediumorchid4"))

ggsave("figs/fig1/disp_e2.jpg", disp_e2, device = "jpeg", width = 5, height = 5)
disp_e2
```


## Figure 2: Summarizing studies
```{r figure 2}
studies <- read.csv("data/modeling_studies.csv")

## A. Studies by Year
year_A <- ggplot(data = studies, aes(x = Year)) +
  geom_bar(fill = "grey50") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +
  ylab("Number of studies") +
  labs(tag = "A") +
  newtheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## B. Studies by country
## refactor countries first
studies %>%
  mutate(Country = fct_recode(Country, Other = "India", Other = "Israel", Other = "Kenya")) -> studies
## then plot   
country_B <- ggplot(data = studies, aes(x = fct_relevel(reorder(Country, Country, function(x)-length(x)), 
                                            "Multiple (Africa)", "Multiple (global)", 
                                           "Other", "Hypothetical", after = 10))) + 
  geom_bar(fill = "grey50") +
  scale_y_continuous(breaks = seq(0, 10, by = 2), labels = scales::number_format(accuracy = 1)) +
  ylab("Number of studies") +
  xlab("") +
  labs(tag = "B") +
  newtheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

## C. R0 plot
r_ests <- read.csv("data/r_ests.csv")
R0_C <- ggplot(data = filter(r_ests, R_type == "R0"), aes(x = Estimate)) +
  geom_histogram(binwidth = 0.25, color = "white", fill = "grey50") +
  scale_y_continuous(labels = scales::number_format(accuracy = 1)) +
  labs(tag = "C") +
  xlab("R0 estimate") +
  ylab("Number of studies") +
  newtheme

## D. Key modeling decisions and features
studies %>%
  select(14:20) %>%
  gather() %>%
  filter(value %in% "Y") %>%
  group_by(key) %>%
  summarize(proportion = n()/51) -> summary
features_D <- ggplot(data = summary, aes(x = reorder(key, -proportion), y = proportion)) +
  geom_col(fill = "grey50") +
  scale_x_discrete(labels = c("DDT", 
                              "Fit to data", "Stochastic", "Spatial", 
                              "Heterogeneity", "Introductions", 
                              "Underreporting")) +
  ylab("Proportion of studies") +
  ylim(c(0, 0.8)) +
  xlab("") +
  labs(tag = "D") +
  newtheme +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


fig2 <- year_A + R0_C + country_B + features_D + plot_layout(ncol = 2, nrow = 2)
ggsave("figs/fig2.jpg", fig2, device = "jpeg", width = 20, height = 15)
fig2
```


## Figure 3: data
```{r Fig 3}
## Reported data
repdata <- read.csv("data/reported_data.csv")
repdata %>%
  mutate(Nobs_maxed = case_when(Nobs < 250 ~ as.numeric(Nobs), Nobs >= 250 ~ 250), 
         Spatial.scale = fct_relevel(Spatial.scale, "National", after = Inf), 
         Temporal.scale = fct_relevel(Temporal.scale, "Month", after = 2)) -> repdata

data_A <- ggplot(data = repdata, aes(x = reorder(Type.of.data, Type.of.data,function(x)-length(x)))) + 
  geom_bar() +
  newtheme +
  scale_x_discrete(labels = c("Clinical and lab \n confirmed animal cases", 
                              "Reported human \n deaths", 
                              "Sequence data", "Lab confirmed \n animal cases", 
                              "Lab confirmed \n human exposures", "Reported \n animal bites")) +
  xlab("Type of data") +
  ylab("Number of data \n sources") +
  labs(tag = "A") +
  coord_flip()

data_B <- ggplot(data = repdata, aes(x = Temporal.scale, y = Length, fill = Spatial.scale, size = Nobs_maxed)) +
  ggbeeswarm::geom_beeswarm(cex = 3.5, alpha = 0.75, shape = 21, color = "grey50", stroke = 1.5) +
  scale_fill_manual(values = c("Darkred", "Red", "Pink", "Grey50"), name = "Spatial scale") +
  scale_size_area(name = "# of Observations", breaks = c(10, 100, 150, 250), 
                       labels = c("10", "100", "150", "250+")) +
  ylab("Length of time \n series (years)") +
  xlab("Temporal scale") +
  newtheme +
  labs(tag = "B") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  guides(fill = guide_legend(override.aes = list(size = 3)))
fig3 <- data_A + data_B + plot_layout(ncol = 2, widths = c(1, 1))
ggsave("figs/fig3.jpeg", plot = fig3, device = "jpeg", height = 6, width = 15)
fig3

```

## Figure 4

```{r extra upset plots}
studies %>%
  mutate_at(c(14:20), function(x) ifelse(x == "N" | is.na(x), 0, 1)) %>%
  select(c(1, 14:20)) -> studies_set
names(studies_set)
names(studies_set) <- c("Reference", "Fit to data", "Underreporting", "Introductions", 
                        "Heterogeneity", 
                        "DDT", "Stochastic", "Spatial")
upset(studies_set, nsets = 8, nintersects = NA, 
      sets.x.label = "Features", mainbar.y.label = "Number of studies")

## Study category
studies %>%
  mutate_at(vars(starts_with("Category")), 
            function(x) ifelse(x == "N" | is.na(x), 0, 1)) %>%
  select(Reference, starts_with("Category")) -> categories
names(categories)
names(categories) <- c("Reference", "Explain patterns",
                       "Estimate parameters", "Study control",
                       "Identify drivers", "Predict trends")

## Upset plot
pdf("figs/fig4.pdf", onefile = TRUE, width = 10, height = 8)
upset(categories, nsets = 5, nintersects = NA,
      sets.x.label = "Type of study", mainbar.y.label = "Number of studies", text.scale = 2)
dev.off()

## Bar plot
studies %>%
  select(Reference, starts_with("Category")) %>%
  gather() %>%
  filter(value %in% "Y") -> cat_summary
table(cat_summary$key)

```


```{r print session info}
sessionInfo()
```
